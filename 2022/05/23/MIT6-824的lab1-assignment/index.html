<!DOCTYPE html>
<html lang="en">

  <head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="keywords" content="" />
  <meta name="author" content="lane" />
  <meta name="description" content="it, maybe poem" />
  
  
  <title>
    
      MIT6.824çš„lab1 assignment 
      
      
    
  </title>

  
    <link rel="apple-touch-icon" href="/images/favicon.png">
    <link rel="icon" href="/images/favicon.png">
  

  <!-- Raleway-Font -->
  <link href="https://fonts.googleapis.com/css?family=Montserrat|Roboto:400,400italic,600|Roboto+Mono" rel="stylesheet">

  <!-- hexo site css -->
  
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <!-- jquery3.3.1 -->
  <script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script>

  <!-- fancybox -->
  <link href="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.css" rel="stylesheet">
  <script async src="https://cdn.bootcss.com/fancybox/3.5.2/jquery.fancybox.min.js"></script>
  
<script src="/js/fancybox.js"></script>


<meta name="generator" content="Hexo 6.2.0"></head>


  <body>
    <div id="app">
      <div class="header">
  <a href="/">lane' blog</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="github" target="_blank" href="">
      <i class="iconfont icon-github"></i>
    </a>
  
    <a title="email" target="" href="">
      <i class="iconfont icon-envelope"></i>
    </a>
  
    <a title="facebook" target="" href="">
      <i class="iconfont icon-facebooksquare"></i>
    </a>
  
    <a title="twitter" target="" href="">
      <i class="iconfont icon-twitter"></i>
    </a>
  
    <a title="wechat" target="" href="">
      <i class="iconfont icon-wechat"></i>
    </a>
  
    <a title="weibo" target="" href="">
      <i class="iconfont icon-weibo"></i>
    </a>
  
    <a title="rss" target="_blank" href="/atom.xml">
      <i class="iconfont icon-rss"></i>
    </a>
  
</p>


      <div class="main">
        <!-- æ–‡ç« è¯¦æƒ…é¡µï¼Œå±•ç¤ºæ–‡ç« å…·ä½“å†…å®¹ï¼Œurlå½¢å¼ï¼šhttps://yoursite/æ–‡ç« æ ‡é¢˜/ -->
<!-- åŒæ—¶ä¸ºã€Œæ ‡ç­¾tagã€ï¼Œã€Œæœ‹å‹friendã€ï¼Œã€Œåˆ†ç±»categoriesã€ï¼Œã€Œå…³äºaboutã€é¡µé¢çš„æ‰¿è½½é¡µé¢ï¼Œå…·ä½“å±•ç¤ºå–å†³äºpage.type -->

<!-- LaTex Display -->
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js">
</script>
<script>
  MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    }
  };
</script>

<div class="post">
  <h3 class="date">
    May 23, 2022
  </h3>
  <h1>
    MIT6.824çš„lab1 assignment
  </h1>
  <div class="content markdown-body">
    <p>å‰å‡ å¤©åˆæ­¥å®Œæˆäº†mit6.824è¯¾ç¨‹çš„lab1å®éªŒï¼Œä¸‹é¢è®°å½•ä¸€äº›æ€»ç»“å’Œå‘ç‚¹ã€‚è¿™æ˜¯2020å¹´ç‰ˆçš„å®éªŒè¦æ±‚ã€‚ï¼ˆæœ‰æ„æ€çš„æ˜¯ï¼Œåœ¨æœ€æ–°2022ç‰ˆçš„å®éªŒä¸­ï¼Œå‘½åä¸ºâ€œmasterâ€çš„ç›¸å…³æ¨¡å—<br>å·²ç»æ”¹æˆäº†â€œcoordinatorâ€çš„æ¨¡å—ï¼Œè€Œâ€œworkerâ€ç›¸å…³æ¨¡å—çš„å‘½ååˆ™æ²¡æœ‰æ”¹åŠ¨ğŸ˜…ï¼‰å› ä¸ºä¸€å¼€å§‹æ²¡æœ‰æœåˆ°æœ€æ–°ç‰ˆæœ¬çš„lab1ï¼Œå› æ­¤å°†é”™å°±é”™é‡‡ç”¨2020å¹´ç‰ˆæœ¬ï¼Œè¿™ä¸€ç‰ˆæœ¬å’Œæœ€æ–°ç‰ˆæœ¬çš„å·®å¼‚åº”è¯¥ä¸å¤§ã€‚ä¸è¿‡è¿˜æ˜¯å»ºè®®ç›´æ¥é‡‡ç”¨æœ€æ–°ç‰ˆæœ¬ã€‚</p>
<h3 id="å·¥å…·è¦æ±‚"><a href="#å·¥å…·è¦æ±‚" class="headerlink" title="å·¥å…·è¦æ±‚"></a>å·¥å…·è¦æ±‚</h3><p>ç”¨gitæ‹‰å–å·²æœ‰çš„ç›¸å…³æ¨¡å—ï¼Œå†goå®ç°lab1ã€‚ä»£ç åº“ä¸­å·²ç»å®ç°äº†é¡ºåºå®ç°ç‰ˆæœ¬å¯ä¾›å‚è€ƒã€‚ä½äº<strong>src&#x2F;main&#x2F;mrsequential.go</strong>ã€‚åŒæ—¶è¿˜æä¾›äº†MapReduceç¨‹åºçš„ç›¸å…³æ’ä»¶ï¼šå•è¯ç»Ÿè®¡å®ä¾‹ï¼ˆ<strong>mrapps&#x2F;wc.go</strong>ï¼‰å’Œç´¢å¼•æ’åºï¼ˆ<strong>mrapps&#x2F;indexer.go</strong>ï¼‰ã€‚å¯ä»¥åƒä¸‹é¢è¿™æ ·æ‰§è¡Œï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">$ git clone git://g.csail.mit.edu/6.824-golabs-2020 6.824</span><br><span class="line">$ cd ~/6.824</span><br><span class="line">$ cd src/main</span><br><span class="line">$ go build -buildmode=plugin ../mrapps/wc.go</span><br><span class="line">$ rm mr-out*</span><br><span class="line">$ go run mrsequential.go wc.so pg*.txt</span><br><span class="line">$ more mr-out-0</span><br><span class="line">A 509</span><br><span class="line">ABOUT 2</span><br><span class="line">ACT 8</span><br><span class="line">...</span><br></pre></td></tr></table></figure>

<p>mrsequential.goçš„è¾“å‡ºåœ¨<strong>mr-out-0</strong>ä¸­ï¼Œè¾“å…¥æ–‡ä»¶åˆ™ç±»ä¼¼<strong>pg-xxx.txt</strong></p>
<h3 id="å®éªŒè¦æ±‚"><a href="#å®éªŒè¦æ±‚" class="headerlink" title="å®éªŒè¦æ±‚"></a>å®éªŒè¦æ±‚</h3><p>å®ç°ä¸€ä¸ªåˆ†å¸ƒå¼çš„MapReduceç¨‹åºï¼ŒåŒ…æ‹¬masterå’Œworkerã€‚åªæœ‰ä¸€ä¸ªmasterè¿›ç¨‹ï¼Œå’Œå¤šä¸ªå¹¶è¡Œå¤„ç†çš„workerè¿›ç¨‹ã€‚è¿™ä¸ªå®éªŒåªè¦æ±‚å•æœºå®ç°ï¼Œä¸éœ€è¦çœŸæ­£çš„åˆ†å¸ƒå¼å¤šæœºç¯å¢ƒï¼Œworkeré€šè¿‡rpcä¸masteré€šä¿¡ï¼Œworkerä»masterè¯·æ±‚ä¸€ä¸ªä»»åŠ¡ã€‚å¦‚æœworkeråœ¨ä¸€å®šæ—¶é—´å†…ï¼ˆlab1ç»™å®š10ç§’ï¼‰æ²¡èƒ½å®Œæˆï¼Œmasterå°†ä¼šæŠŠè¿™ä¸ªä»»åŠ¡åˆ†é…ç»™å…¶ä»–workeræ‰§è¡Œã€‚</p>
<blockquote>
<p>2022ç‰ˆçš„è¯¾ç¨‹ä½œä¸šæœ€åæ–°å¢äº†é¢å¤–æŒ‘æˆ˜éƒ¨åˆ†ï¼šå®ç°è‡ªå·±çš„MapReduceæ’ä»¶ï¼ŒåŒæ—¶åœ¨çœŸæ­£å¤šæœºæ¯”å¦‚äºšé©¬é€Šæä¾›çš„äº‘æœåŠ¡å®ä¾‹ç¯å¢ƒä¸­è¿è¡Œï¼Œéœ€è¦æŠŠUnixå¥—æ¥å­—é€šä¿¡æ¢æˆTCP&#x2F;IPçš„å½¢å¼</p>
</blockquote>
<h3 id="è®¾è®¡æ€è·¯ï¼š"><a href="#è®¾è®¡æ€è·¯ï¼š" class="headerlink" title="è®¾è®¡æ€è·¯ï¼š"></a>è®¾è®¡æ€è·¯ï¼š</h3><p>ä»£ç åº“å·²ç»™å®šäº†æ•´ä½“æ¡†æ¶å’Œæµ‹è¯•ç”¨ä¾‹ï¼Œå› æ­¤åªéœ€è¦å®Œæˆä¸Šè¿°å…³é”®ç»†èŠ‚å³å¯ã€‚</p>
<p>1ã€åœ¨masterèŠ‚ç‚¹åº”æœ‰å•ç‹¬çš„rpcæœåŠ¡ï¼ˆå¯ä»¥æ˜¯ä¸€ä¸ªgoroutineï¼‰å’Œä¸€ä¸ªå•ç‹¬çš„å…¬å…±å®šæ—¶å™¨æœåŠ¡ï¼ˆå¯è‡ªå·±è®¾è®¡ä¸ºä¸€ä¸ªgoroutineï¼‰ã€‚workeråˆ™æ˜¯ä¸€ä¸ªå¾ªç¯è¯·æ±‚ä»»åŠ¡+sleepçš„goroutineã€‚</p>
<p>2ã€masterèŠ‚ç‚¹åˆ†ä¸ºä¸»goroutine+åå°rpc goroutineï¼ˆå·²æœ‰ï¼‰+å®šæ—¶å™¨goroutineã€‚å½“rpcæ¥æ”¶ä¸€ä¸ªè¯·æ±‚æ—¶ä¼šè¿è¡Œä¸€ä¸ªä¸´æ—¶goroutineå¤„ç†è¯·æ±‚ç›¸å…³äº‹åŠ¡ã€‚å¯ä»¥é€šè¿‡channelå’Œä¸»goroutineè¿›è¡Œäº¤æµã€‚masterèŠ‚ç‚¹éœ€è¦è®°å½•ï¼š</p>
<ul>
<li><strong>ä»»åŠ¡çŠ¶æ€</strong>ï¼Œå¦‚ç­‰å¾…è¢«æ¶ˆè´¹ã€è¢«æ¶ˆè´¹æœªå®Œæˆã€æ¶ˆè´¹å·²è¶…æ—¶ã€è¢«æ¶ˆè´¹å·²å®Œæˆç­‰ã€‚è¿™ä¹Ÿç¬¦åˆmap reduceè®ºæ–‡ä¸­æåˆ°çš„ä»»åŠ¡ä¸èƒ½é‡å¤æäº¤çš„è¦æ±‚ã€‚</li>
<li><strong>ä»»åŠ¡idå’Œæ–‡ä»¶åçš„æ˜ å°„</strong>ã€‚åœ¨ä¸»goroutineåˆå§‹åŒ–æ—¶ï¼Œåˆ†åˆ«ç»™æ¯ä¸ªæ–‡ä»¶åä¸€ä¸ªä»»åŠ¡idã€‚</li>
<li><strong>Rä»»åŠ¡çš„æ•°é‡</strong>ï¼ˆlab1ä»£ç åº“ä¸­å·²å½“æˆå‚æ•°ä¼ é€’è¿›æ¥äº†ï¼‰ä»¥åŠRä»»åŠ¡çš„å·²å®Œæˆæ•°é‡ï¼Œæ–¹ä¾¿åˆ¤æ–­Reduceé˜¶æ®µæ˜¯å¦å·²å®Œæˆã€‚å®Œæˆçš„è¯ç¨‹åºå³å¯é€€å‡ºã€‚</li>
<li><strong>Mä»»åŠ¡æ•°é‡</strong>ï¼ˆè¿™é‡Œçš„æ€»æ•°å³æ˜¯ç»™å®šçš„pg-xxx.txtæ–‡ä»¶çš„æ•°é‡ï¼‰ä»¥åŠMä»»åŠ¡çš„å·²å®Œæˆæ•°é‡ï¼Œæ–¹ä¾¿åˆ¤æ–­Mapé˜¶æ®µæ˜¯å¦å·²ç»å®Œæˆï¼Œæ˜¯å¦åº”è¯¥åˆ‡æ¢åˆ°Reduceé˜¶æ®µã€‚</li>
<li><strong>ç­‰å¾…è¢«æ¶ˆè´¹çš„ä»»åŠ¡idçš„é˜Ÿåˆ—é›†åˆ</strong>ï¼ˆå¯ä»¥ç”¨channelå®ç°ï¼‰ã€‚åˆå§‹åŒ–æ—¶å¯ä»¥æŠŠä»»åŠ¡ä¾æ¬¡æ”¾å…¥channelä¸­ï¼Œworkerè¯·æ±‚ä»»åŠ¡æ—¶å¯ä»¥ä»channelä¸­æ¥æ”¶ï¼ˆå‰æè¦åˆ¤æ–­channelé•¿åº¦ï¼Œä¸ç„¶å¯èƒ½ä¼šé˜»å¡ï¼‰ï¼Œå¹¶å°†ä»»åŠ¡æ ‡è®°ä¸ºå·²æ¶ˆè´¹çŠ¶æ€ï¼Œå†æ·»åŠ åˆ°è¶…æ—¶ç›‘æ§é˜Ÿåˆ—ä¸­å»ã€‚ä»»åŠ¡è¶…æ—¶åå†æŠŠä»»åŠ¡æ”¾å…¥å¾…æ¶ˆè´¹ä»»åŠ¡é˜Ÿåˆ—ä¸­ã€‚è¿™é‡Œç›¸å…³çš„channelæ“ä½œéƒ½è¦å…ˆåˆ¤æ–­é•¿åº¦ï¼Œé¿å…é˜»å¡çš„æƒ…å†µï¼ˆå¯ä»¥å°†channelè®¾ç½®æˆæœ‰ä¸€å®šé•¿åº¦çš„ç¼“å†²åŒºçš„ï¼‰ã€‚</li>
<li><strong>å·²ç»å®Œæˆçš„ä»»åŠ¡idçš„é˜Ÿåˆ—é›†åˆ</strong>ï¼ˆchannelï¼‰ã€‚rpcæ”¶åˆ°ä»»åŠ¡å®Œæˆçš„è¯·æ±‚åï¼Œå°†ä»»åŠ¡idé€šè¿‡channelå‘ç»™å®šæ—¶å™¨æœåŠ¡ã€‚å®šæ—¶å™¨æœåŠ¡æ”¶åˆ°é€šçŸ¥åå°†æ­¤ä»»åŠ¡idä»è¶…æ—¶ç›‘æ§é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œé¿å…ä»»åŠ¡è¶…æ—¶ååˆè¢«é‡æ–°æ”¾å›å¾…æ¶ˆè´¹é˜Ÿåˆ—ä¸­ã€‚</li>
<li><strong>è¶…æ—¶ç›‘æ§é˜Ÿåˆ—é›†åˆ</strong>ï¼ˆchannelï¼‰ã€‚å…¬å…±å®šæ—¶å™¨æœåŠ¡å®šæ—¶ç›‘æ§æ‰€æœ‰ä»»åŠ¡å®Œæˆæƒ…å†µï¼Œè®¾å®šä¸€ä¸ªæœ€è¿‘çš„å®šæ—¶ï¼Œåœ¨è¶…æ—¶åæ£€æŸ¥ä»»åŠ¡å®Œæˆä¸å¦ï¼Œæ‰§è¡Œæ—¶é—´æ˜¯å¦å·²ç»è¶…è¿‡10ç§’ã€‚å®šæ—¶å™¨goroutineå¯ä»¥æ˜¯forå¾ªç¯+selectå¤šä¸ªchannelçš„æ“ä½œã€‚</li>
<li>å½“æ‰€æœ‰ä»»åŠ¡å®Œæˆåéœ€è¦é€šçŸ¥å®šæ—¶å™¨goroutineé€€å‡ºã€‚</li>
</ul>
  <img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/overview.jpg" class="" title="æ•´ä½“æ¡†æ¶">

<p>  æ•´ä½“æ¡†æ¶å¦‚ä¸Šå›¾æ‰€ç¤º</p>
  <img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/cp1.jpg" class="" title="consumeAndproduce">

<p>  è®¾è®¡æ€è·¯æ€»ç»“å°±æ˜¯ä¸€ä¸ªç”Ÿäº§-æ¶ˆè´¹è€…æ¨¡å‹ã€‚è¿™é‡Œæ³¨æ„ï¼šæ¶‰åŠåˆ°å…±äº«æ•°æ®ï¼ˆä¸´ç•ŒåŒºï¼‰çš„éœ€è¦åŠ é”æ“ä½œã€‚</p>
<h3 id="è¸©å‘è®°å½•"><a href="#è¸©å‘è®°å½•" class="headerlink" title="è¸©å‘è®°å½•"></a>è¸©å‘è®°å½•</h3><h4 id="ç‰ˆæœ¬å·®å¼‚"><a href="#ç‰ˆæœ¬å·®å¼‚" class="headerlink" title="ç‰ˆæœ¬å·®å¼‚"></a>ç‰ˆæœ¬å·®å¼‚</h4><p>æœ€æ–°ç‰ˆæœ¬çš„goå·²ç»åˆ°1.18.1äº†ï¼Œè€ŒåŸæœ‰ä»£ç åº“è¿˜æ˜¯é‡‡ç”¨1.13.1çš„ç‰ˆæœ¬ã€‚å› æ­¤è§„èŒƒçš„åšæ³•æ˜¯å°†ä»£ç åº“çš„ç»„ç»‡ã€ä¾èµ–ç®¡ç†æ”¹æˆgo moduleçš„å½¢å¼ã€‚åŸæœ‰ä»£ç è¿˜æ˜¯é€šè¿‡ç›¸å¯¹è·¯å¾„çš„å½¢å¼å¯¼å…¥å¼•ç”¨ï¼Œè€Œgo moduleä¸æ”¯æŒè¿™ç§æ–¹å¼ã€‚åœ¨è®¾ç½®æˆgo moduleæ–¹å¼åï¼Œå¯ä»¥åœ¨<strong>6.824</strong>æ ¹ç›®å½•æ‰§è¡Œ<strong>go mod init xxx</strong>æ›´æ–°é¡¹ç›®çš„ä¾èµ–ç®¡ç†ï¼ŒåŒæ—¶å°†ä»£ç åº“ä¸­çš„æ‰€æœ‰ç›¸å¯¹è·¯å¾„çš„å¼•ç”¨æ”¹æˆ<strong>è‡ª6.824æ ¹ç›®å½•å¼€å§‹çš„è·¯å¾„</strong>ã€‚ä¾‹å¦‚ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &quot;../mr&quot;</span><br></pre></td></tr></table></figure>

<p>æ”¹æˆ</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">import &quot;6.824/src/mr&quot;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“ go moduleçš„è®¾ç½®å¯ä»¥ä¸Šç½‘æœç´¢å‚è€ƒã€‚</p>
<h4 id="channelç›¸å…³"><a href="#channelç›¸å…³" class="headerlink" title="channelç›¸å…³"></a>channelç›¸å…³</h4><p>ç”±äºä¸ªäººçš„è®¾è®¡æ€è·¯æ˜¯é‡‡ç”¨channelæ–¹å¼è¿›è¡Œgoroutineé€šçŸ¥ï¼Œå› æ­¤åœ¨channeléƒ¨åˆ†è¸©äº†å¾ˆå¤šå‘ã€‚ä¾‹å¦‚ï¼Œchannelæ²¡æœ‰åˆå§‹åŒ–ï¼Œæ²¡æœ‰åˆç†è®¾ç½®ç¼“å†²åŒºï¼Œä½¿å¾—masteråœ¨æˆåŠŸæ¥æ”¶rpcè¯·æ±‚åä¸€ç›´æ— æ³•é¡ºåˆ©å®Œæˆè¯·æ±‚å¤„ç†å¹¶è¿”å›ç»™workerã€‚æ·»åŠ æ‰“å°èƒ½çœ‹åˆ°masterå·²ç»æ¥æ”¶è¯·æ±‚äº†ï¼Œä½†æ˜¯åç»­æ— æ³•å¤„ç†è¿”å›ï¼Œä¼šä¸€ç›´æç¤ºï¼š</p>
<img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/unexpectedeof.jpg" class="" title="æ•´ä½“æ¡†æ¶">

<p>channelå¦‚æœåªæ˜¯å£°æ˜è€Œæ²¡æœ‰åˆå§‹åŒ–ï¼Œå¯¹è¯¥channelçš„è¯»å†™éƒ½ä¼šé€ æˆé˜»å¡ï¼Œå…³é—­è¯¥channelä¼šå¯¼è‡´panicã€‚åœ¨æµ‹è¯•ä¸­ä¼šæç¤ºå¦‚ä¸‹ï¼š</p>
<img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/channel_1.jpg" class="" title="channel_1">

<p>å¥‡æ€ªçš„æ˜¯ç¼–è¯‘æ—¶å¹¶ä¸ä¼šå¯¹æœªåˆå§‹åŒ–çš„channelçš„ç›¸å…³ä»£ç è¿›è¡Œè­¦å‘Šï¼Œè€Œæ˜¯ç¼–è¯‘é€šè¿‡â€¦</p>
<p>è¿è¡Œè¯¾ç¨‹æä¾›çš„crashæµ‹è¯•ç”¨ä¾‹æ—¶ä¹Ÿæœ‰channelçš„å‘ç‚¹ã€‚è¶…æ—¶ä»»åŠ¡çš„channelä¸€å¼€å§‹è®¾è®¡ä¹Ÿæ˜¯éç¼“å†²åŒºçš„ï¼Œå®šæ—¶å™¨å¾€è¯¥channelå†™æ—¶ä¼šä¸€ç›´é˜»å¡ä½ï¼ˆåœ¨ä¸´æ—¶goroutineä¸­é˜»å¡ï¼‰ã€‚è€Œä¸»goroutineåˆ¤æ–­æ—¶é‡‡ç”¨å†…ç½®çš„lenå‡½æ•°åˆ¤æ–­è¶…æ—¶ä»»åŠ¡çš„æ•°é‡éƒ½ä¼šè¿”å›0ï¼Œé€»è¾‘åˆ¤æ–­é•¿åº¦å¤§äº0æ‰ä¼šä»è¯¥channelä¸­æ¥æ”¶è¶…æ—¶ä»»åŠ¡ï¼ˆç¬¬4è¡Œï¼‰ã€‚æ‰€ä»¥è¶…æ—¶ä»»åŠ¡ä¸€ç›´æ²¡æœ‰è¢«ä¸»goroutineæ­£ç¡®æ¥æ”¶å¹¶é‡æ–°åŠ å…¥å¾…æ¶ˆè´¹é˜Ÿåˆ—ä¸­ï¼ˆä¸´æ—¶é€šçŸ¥è¶…æ—¶ä»»åŠ¡çš„goroutineä¹Ÿä¸€ç›´é˜»å¡ä½æ²¡æœ‰å›æ”¶ï¼Œåç»­ä¼šæœ‰æ³„éœ²çš„é£é™©ï¼‰ï¼Œè¿™å¯¼è‡´workeråç»­æ²¡æœ‰è¯·æ±‚åˆ°ä»»åŠ¡ï¼Œmasterä¹Ÿæ²¡æœ‰æ£€æŸ¥åˆ°è¶…æ—¶ä»»åŠ¡ï¼Œä¸¤è€…ä¸€ç›´ç©ºè½¬â€¦æœ€ç»ˆå¯¼è‡´æµ‹è¯•å¤±è´¥ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">// ä¸»goroutineåˆ¤æ–­æ˜¯å¦å­˜åœ¨è¶…æ—¶ä»»åŠ¡å¹¶å–å‡ºé‡æ–°è®¾ç½®çŠ¶æ€ï¼Œæ·»åŠ åˆ°å¾…æ¶ˆè´¹é˜Ÿåˆ—</span><br><span class="line">func (m *Master) CheckTaskExpire() &#123;</span><br><span class="line">	len := len(m.ExpireC)</span><br><span class="line">	if len &gt; 0 &#123;</span><br><span class="line">		mu.Lock()</span><br><span class="line">		defer mu.Unlock()</span><br><span class="line">		for ; len &gt; 0; len-- &#123;</span><br><span class="line">			expiredId := &lt;-m.ExpireC</span><br><span class="line">			m.AddTask(expiredId)</span><br><span class="line">			m.TaskState[expiredId] = WAITING</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åæ¥æ”¹æˆå£°æ˜+åˆå§‹åŒ–ä¸€å®šé•¿åº¦è®¾ç½®ç¼“å†²åŒºåï¼Œchannelçš„ç›¸å…³æ“ä½œå°±æ²¡é—®é¢˜äº†ã€‚</p>
<h4 id="ä¸´ç•ŒåŒºèµ„æº"><a href="#ä¸´ç•ŒåŒºèµ„æº" class="headerlink" title="ä¸´ç•ŒåŒºèµ„æº"></a>ä¸´ç•ŒåŒºèµ„æº</h4><p>ç”±äºmasterçš„æ•°æ®ç”±å¤šä¸ªworkeré€šè¿‡rpcè®¿é—®ã€‚å› æ­¤æœ‰äº›æ•°æ®ä¼šåœ¨å¤šä¸ªgoroutineé—´ç«äº‰å…±äº«ã€‚æ‰€ä»¥éœ€è¦ç”¨sync.Mutexæ’ä»–é”ï¼Œåœ¨è¿›å…¥ä¸´ç•ŒåŒºæ—¶åŠ é”ï¼Œåœ¨é€€å‡ºä¸´ç•ŒåŒºæ—¶è§£é”ã€‚å¦‚æœæ²¡æœ‰è®¾ç½®é”ã€‚ç¼–è¯‘ä¼šæœ‰è­¦å‘Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">WARNING: DATA RACE</span><br></pre></td></tr></table></figure>

<h4 id="goroutineå¼‚å¸¸å¯¼è‡´æ³„éœ²"><a href="#goroutineå¼‚å¸¸å¯¼è‡´æ³„éœ²" class="headerlink" title="goroutineå¼‚å¸¸å¯¼è‡´æ³„éœ²"></a>goroutineå¼‚å¸¸å¯¼è‡´æ³„éœ²</h4><p>ä¸€å¼€å§‹åœ¨è°ƒè¯•æ—¶ç»å¸¸å‡ºç°è¿™æ ·çš„æç¤ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">race: limit on 8128 simultaneously alive goroutines is exceeded, dyingï¼š</span><br></pre></td></tr></table></figure>

<p>å¾ˆæ˜æ˜¾ç”±äºä¸å½“æ“ä½œå¯¼è‡´goroutineæ•°é‡è¶…è¿‡ä¸Šé™äº†ï¼Œå¤§é‡goroutineä¼šå¯¼è‡´goé¢‘ç¹è°ƒåº¦äº§ç”Ÿä¸å°çš„ä¸Šä¸‹æ–‡åˆ‡æ¢å¼€é”€ï¼Œè€Œä¸”goroutineä¹‹é—´çš„èµ„æºç«äº‰é—®é¢˜çªå‡ºã€‚é€šè¿‡<strong>go tool trace</strong>åˆ†ææ’æŸ¥æœ€ç»ˆç¡®å®šé—®é¢˜</p>
<img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/pprof_3.jpg" class="" title="pprof">

<p>åˆ†ææ˜¾ç¤ºnoticeExpireè°ƒç”¨äº§ç”Ÿäº†6063ä¸ªgoroutineï¼Œè¿™æ˜¾ç„¶ä¸åˆå¸¸ç†ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">select &#123;</span><br><span class="line">case t := &lt;-timer.C: //expired</span><br><span class="line">  // calculate what task expired and clean from queue</span><br><span class="line">  timer.Stop()</span><br><span class="line">  var expireRecs TaskTimeRecs</span><br><span class="line">  var newTimeRecs TaskTimeRecs</span><br><span class="line">  for _, v := range m.TimeRecs &#123;</span><br><span class="line">    if v.Expire.Before(t) || v.Expire.IsZero() &#123;</span><br><span class="line">      expireRecs = append(expireRecs, v)</span><br><span class="line">      continue</span><br><span class="line">    &#125;</span><br><span class="line">    newTimeRecs = append(newTimeRecs, v)</span><br><span class="line">  &#125;</span><br><span class="line">  m.TimeRecs = newTimeRecs</span><br><span class="line">  go m.noticeExpire(expireRecs)</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæ˜¯åœ¨å®šæ—¶å™¨goroutineä¸­æ‰§è¡Œçš„ï¼Œå½“æœ€è¿‘çš„ä»»åŠ¡è¶…æ—¶æ—¶ï¼Œä¼šå°†å·²è¶…æ—¶çš„ä»»åŠ¡ç­›é€‰å‡ºæ¥å¹¶æ”¾å…¥è¶…æ—¶é˜Ÿåˆ—ã€‚ç”±äºåˆå§‹è®¾è®¡æ—¶è¶…æ—¶é˜Ÿåˆ—å¯¹åº”çš„channelæ²¡æœ‰è®¾ç½®ç¼“å†²åŒºï¼Œå› æ­¤ä¸ºäº†ä¸é˜»å¡å®šæ—¶å™¨goroutineçš„åç»­æ“ä½œï¼Œé€šè¿‡ä¸´æ—¶goroutineè¿›è¡Œæ“ä½œã€‚ï¼ˆåç»­å·²ç»è®¾ç½®ä¸€å®šæ•°é‡çš„ç¼“å­˜åŒºäº†ï¼‰ã€‚é€šè¿‡æ‰“å°å‘ç°æœ€è¿‘çš„è¶…æ—¶æ—¶é—´ä¸€ç›´æ˜¯è¿‡å»çš„æ—¶é—´ï¼Œå› æ­¤ä¸åœåœ°è§¦å‘è¶…æ—¶ï¼Œç›´åˆ°goroutineè¾¾åˆ°ä¸Šé™æŠ¥é”™ã€‚æ‰€ä»¥åº”è¯¥æ˜¯è¶…æ—¶ç›‘æ§é˜Ÿåˆ—çš„æ•°æ®å‡ºäº†é—®é¢˜ã€‚æœ€åé€šè¿‡æ’æŸ¥å‘ç°åœ¨workeré€šçŸ¥å®šæ—¶å™¨æœ‰ä»»åŠ¡å®Œæˆæäº¤æ—¶ï¼Œå®šæ—¶ç›‘æ§é˜Ÿåˆ—çš„æ›´æ–°å‡ºäº†é—®é¢˜ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">func (m *Master) deleteTaskTimeRec(taskId int) &#123;</span><br><span class="line">  ... // è®¡ç®—å®Œæˆçš„ä»»åŠ¡çš„ä¸‹æ ‡index</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		mu.Lock()</span><br><span class="line">		defer mu.Unlock()</span><br><span class="line">		m.TaskState[taskId] = COMPLETED</span><br><span class="line">		m.TimeRecs = append(m.TimeRecs[:index], m.TimeRecs[:index+1]...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>indexæ˜¯å·²å®Œæˆçš„ä»»åŠ¡åœ¨è¶…æ—¶ç›‘æ§é˜Ÿåˆ—ä¸­çš„ä¸‹æ ‡ï¼Œè¿™é‡Œé€»è¾‘æœ¬æ„æ˜¯è®¡ç®—å‡ºä¸‹æ ‡åï¼Œé€šè¿‡åˆ‡ç‰‡æ“ä½œåˆ é™¤è¯¥ä»»åŠ¡çš„æ•°æ®ï¼Œç»“æœè¯¯å†™æˆ <strong>append(m.TimeRecs[:index], m.TimeRecs[:index+1]â€¦)</strong> ğŸ˜…ã€‚æ­£ç¡®çš„é€»è¾‘åº”è¯¥æ˜¯ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">func (m *Master) deleteTaskTimeRec(taskId int) &#123;</span><br><span class="line">  ... // è®¡ç®—å®Œæˆçš„ä»»åŠ¡çš„ä¸‹æ ‡index</span><br><span class="line">	if index &lt; 0 &#123;</span><br><span class="line">		return</span><br><span class="line">	&#125; else &#123;</span><br><span class="line">		mu.Lock()</span><br><span class="line">		defer mu.Unlock()</span><br><span class="line">		m.TaskState[taskId] = COMPLETED</span><br><span class="line">		m.TimeRecs = append(m.TimeRecs[:index], m.TimeRecs[index+1:]...)</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ”¹å®Œä¹‹åè¡¨ç°å°±æ­£å¸¸äº†ã€‚</p>
<h4 id="å®šæ—¶å™¨è®¾è®¡"><a href="#å®šæ—¶å™¨è®¾è®¡" class="headerlink" title="å®šæ—¶å™¨è®¾è®¡"></a>å®šæ—¶å™¨è®¾è®¡</h4><p>å®šæ—¶å™¨çš„è®¾è®¡è¿˜è¸©äº†å¦ä¸€ä¸ªå‘ï¼šåœ¨forå¾ªç¯ä¸­ï¼Œèµ°äº†ifåˆ†æ”¯åæ²¡æœ‰continueé‡æ–°æ‰§è¡Œå¾ªç¯ï¼Œè€Œæ˜¯ç»§ç»­å¾€ä¸‹æ‰§è¡Œäº†elseçš„å†…å®¹ã€‚å¯¼è‡´è§¦å‘äº†å®šæ—¶çš„ä»»åŠ¡è¿˜æ®‹ç•™åœ¨ç›‘æ§é˜Ÿåˆ—ï¼ˆnewTimeRecsï¼‰ä¸­ï¼Œå¯¼è‡´å·²è¿‡æœŸçš„ä»»åŠ¡è¿˜æ˜¯ä¸åœè§¦å‘ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">// å®šæ—¶å™¨forå¾ªç¯ä¸­</span><br><span class="line">for &#123;</span><br><span class="line">  select &#123;</span><br><span class="line">  case t := &lt;-timer.C: //expired</span><br><span class="line">    // calculate what task expired and clean from queue</span><br><span class="line">    timer.Stop()</span><br><span class="line">    var expireRecs TaskTimeRecs</span><br><span class="line">    var newTimeRecs TaskTimeRecs</span><br><span class="line">    for _, v := range m.TimeRecs &#123;</span><br><span class="line">      if v.Expire.Before(t) || v.Expire.IsZero() &#123;</span><br><span class="line">        expireRecs = append(expireRecs, v)</span><br><span class="line">        // æ­¤å¤„åº”è¯¥ continue ç»§ç»­forå¾ªç¯ï¼Œè€Œä¸æ˜¯ç»§ç»­èµ°ä¸‹é¢é€»è¾‘</span><br><span class="line">      &#125;</span><br><span class="line">      newTimeRecs = append(newTimeRecs, v)</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="goæ€§èƒ½åˆ†æå·¥å…·"><a href="#goæ€§èƒ½åˆ†æå·¥å…·" class="headerlink" title="goæ€§èƒ½åˆ†æå·¥å…·"></a>goæ€§èƒ½åˆ†æå·¥å…·</h3><p>åœ¨è¯¾ç¨‹ä¸­é€šè¿‡ä½¿ç”¨goåˆ†æå·¥å…·ï¼ŒæˆåŠŸå®šä½åˆ°goroutineå¼‚å¸¸çš„é—®é¢˜ã€‚å¦åˆ™ä¾èµ–æ‰“å°+æ‰‹å·¥è°ƒè¯•ï¼Œä¸çŸ¥é“è¦èŠ±è´¹å¤šå°‘æ—¶é—´â€¦</p>
<p>åœ¨é¡¹ç›®ä¸­ï¼Œå¯ä»¥åœ¨ä¸»ç¨‹åºçš„mainå‡½æ•°ä¸­æ·»åŠ pprofingç›¸å…³é€»è¾‘ï¼Œåœ¨æ‰§è¡Œç›®å½•ä¸­ä¼šè¾“å‡ºä¸€ä¸ª<strong>trace.out</strong>æ–‡ä»¶ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">func main() &#123;</span><br><span class="line">	f, err := os.Create(&quot;trace.out&quot;)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	defer f.Close()</span><br><span class="line">	err = trace.Start(f)</span><br><span class="line">	if err != nil &#123;</span><br><span class="line">		panic(err)</span><br><span class="line">	&#125;</span><br><span class="line">	defer trace.Stop()</span><br><span class="line">	if len(os.Args) &lt; 2 &#123;</span><br><span class="line">		fmt.Fprintf(os.Stderr, &quot;Usage: mrmaster inputfiles...\n&quot;)</span><br><span class="line">		os.Exit(1)</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">  // ç¨‹åºé€»è¾‘...</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç”Ÿäº§è¾“å‡ºæ–‡ä»¶åï¼Œæ‰§è¡Œ <strong>go tool trace trace.out</strong>ï¼Œä¼šè‡ªåŠ¨å¯åŠ¨ä¸€ä¸ªprofæœåŠ¡ï¼š</p>
<img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/pprof_1.jpg" class="" title="pprof">

<p>å¹¶ä¸”é»˜è®¤æµè§ˆå™¨ä¼šè‡ªåŠ¨è®¿é—®æ­¤ç«¯å£ï¼š</p>
<img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/pprof_2.jpg" class="" title="pprof">

<p>è¾“å‡ºä¿¡æ¯ä¼šæ˜¾ç¤ºç¨‹åºä¸€ç³»åˆ—çš„çŠ¶æ€ä¿¡æ¯ï¼ŒåŒ…æ‹¬goroutineçš„æ•°é‡ã€goroutineçš„å †æ ˆä¿¡æ¯ã€ç½‘ç»œé˜»å¡åˆ†æã€åŒæ­¥é˜»å¡åˆ†æã€è°ƒåº¦å»¶è¿Ÿåˆ†æç­‰ã€‚</p>
<img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/pprof_3.jpg" class="" title="pprof">

<img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/pprof_4.jpg" class="" title="pprof">

<p>ä¸Šå›¾çº¢æ¡†å³goroutineå¼‚å¸¸æ³„éœ²çš„ä¿¡æ¯ã€‚ç‚¹è¿›å»å¯çœ‹åˆ°æ¯ä¸ªgouroutineçš„æ‰§è¡Œæ—¶é—´ã€ç½‘ç»œç­‰å¾…ã€ç³»ç»Ÿè°ƒç”¨é˜»å¡ã€è°ƒåº¦ç­‰å¾…ã€GCç­‰ä¿¡æ¯ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<img src="/2022/05/23/MIT6-824%E7%9A%84lab1-assignment/pprof_5.jpg" class="" title="pprof">

<p>ç”±äºtraceå¯¹ç¨‹åºæ€§èƒ½æœ‰ä¸€å®šå½±å“ï¼Œå› æ­¤çº¿ç¨‹ç”Ÿäº§ç¯å¢ƒè¦è°¨æ…ä½¿ç”¨ã€‚ç›¸å…³ä¿¡æ¯å¯å‚è€ƒ</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://medium.com/justforfunc/using-the-go-execution-tracer-to-speed-up-fractal-rendering-c06bb3760507">https://medium.com/justforfunc/using-the-go-execution-tracer-to-speed-up-fractal-rendering-c06bb3760507</a></li>
<li><a target="_blank" rel="noopener" href="https://making.pusher.com/go-tool-trace/">https://making.pusher.com/go-tool-trace/</a></li>
<li><a target="_blank" rel="noopener" href="https://tonybai.com/2021/06/28/understand-go-execution-tracer-by-example/">https://tonybai.com/2021/06/28/understand-go-execution-tracer-by-example/</a></li>
</ul>
<h3 id="æ€è€ƒ"><a href="#æ€è€ƒ" class="headerlink" title="æ€è€ƒ"></a>æ€è€ƒ</h3><ul>
<li>channelåº”è¯¥è§„èŒƒä½¿ç”¨ï¼Œå£°æ˜å¹¶ä½¿ç”¨makeå®Œæˆåˆå§‹åŒ–ï¼Œå¹¶åˆç†è®¾ç½®ç¼“å†²åŒº</li>
<li>reduceä»»åŠ¡ä»å„ä¸ªæ–‡ä»¶è¯»å–æ•°æ®åï¼Œéœ€è¦å†æ ¹æ®keyè¿›è¡Œä¸€æ¬¡é€’å¢æ’åºï¼Œå¦åˆ™ä¼šæœ‰é—®é¢˜</li>
<li>æ³¨æ„ä»£ç é€»è¾‘è‡ªæ´½</li>
<li>å–„äºä½¿ç”¨å·¥å…·ï¼Œå¦‚å€Ÿç”¨goåˆ†æå·¥å…·å®šä½é—®é¢˜ï¼Œè¾¾åˆ°äº‹åŠåŠŸå€çš„æ•ˆæœ</li>
</ul>
<h3 id="è¯¾ç¨‹ä½œä¸šä»‹ç»"><a href="#è¯¾ç¨‹ä½œä¸šä»‹ç»" class="headerlink" title="è¯¾ç¨‹ä½œä¸šä»‹ç»"></a>è¯¾ç¨‹ä½œä¸šä»‹ç»</h3><ul>
<li><a target="_blank" rel="noopener" href="http://nil.csail.mit.edu/6.824/2020/labs/lab-mr.html">http://nil.csail.mit.edu/6.824/2020/labs/lab-mr.html</a></li>
</ul>

  </div>
  
    
      <a id="older" class="blog-nav" href="/2022/05/21/mapreduce%E8%AE%BA%E6%96%87%E9%98%85%E8%AF%BB/">OLDER&nbsp;&gt;</a>
      
        
            
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        Copyright Â© lane 2021
        
    </div>
  
    <div class="footer-more">
      
        <a target="_blank" rel="noopener" href="https://github.com/leedom92/hexo-theme-leedom">Theme by Leedom | Powered by Hexo</a>
        
    </div>
  
</div>

      </div>

      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>



      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)">
      <i class="iconfont icon-search"></i>
    </a>
  </div>

  <div class="search-overlay hidden">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          <!-- <span class="search-icon-input">
            <a href="javascript: void(0)">
              <i class="iconfont icon-search"></i>
            </a>
          </span> -->
          
            <input type="text" class="search-input" id="search-input" placeholder="$ grep...">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)">
              <i class="iconfont icon-close"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"></div>
      </div>
    </div>
  </div>

  <script type="text/javascript">
    var inputArea = document.querySelector("#search-input")
    var searchOverlayArea = document.querySelector(".search-overlay")

    // inputArea.onclick = function() {
    //   getSearchFile()
    //   this.onclick = null
    // }

    inputArea.onkeydown = function() {
      if(event.keyCode == 13)
        return false
    }

    function openOrHideSearchContent() {
      let isHidden = searchOverlayArea.classList.contains('hidden')
      if (isHidden) {
        searchOverlayArea.classList.remove('hidden')
        document.body.classList.add('hidden')
        inputArea.focus()
        getSearchFile()
      } else {
        searchOverlayArea.classList.add('hidden')
        document.body.classList.remove('hidden')
      }
    }

    function blurSearchContent(e) {
      if (e.target === searchOverlayArea) {
        openOrHideSearchContent()
      }
    }

    document.querySelector("#search-icon").addEventListener("click", openOrHideSearchContent, false)
    document.querySelector("#search-close-icon").addEventListener("click", openOrHideSearchContent, false)
    searchOverlayArea.addEventListener("click", blurSearchContent, false)

    var searchFunc = function (path, search_id, content_id) {
      'use strict';
      var $input = document.getElementById(search_id);
      var $resultContent = document.getElementById(content_id);
      $resultContent.innerHTML = "<ul><span class='local-search-empty'><span></ul>";
      // $resultContent.innerHTML = "<ul><span class='local-search-empty'>First search, index file loading, please wait...<span></ul>";
      $.ajax({
        // 0x01. load xml file
        url: path,
        dataType: "xml",
        success: function (xmlResponse) {
          // 0x02. parse xml file
          var datas = $("entry", xmlResponse).map(function () {
            return {
              title: $("title", this).text(),
              content: $("content", this).text(),
              url: $("url", this).text()
            };
          }).get();
          $resultContent.innerHTML = "";

          $input.addEventListener('input', function () {
            // 0x03. parse query to keywords list
            var str = '<ul class=\"search-result-list\">';
            var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
            $resultContent.innerHTML = "";
            if (this.value.trim().length <= 0) {
              return;
            }
            // 0x04. perform local searching
            datas.forEach(function (data) {
              var isMatch = true;
              var content_index = [];
              if (!data.title || data.title.trim() === '') {
                data.title = "Untitled";
              }
              var orig_data_title = data.title.trim();
              var data_title = orig_data_title.toLowerCase();
              var orig_data_content = data.content.trim().replace(/<[^>]+>/g, "");
              var data_content = orig_data_content.toLowerCase();
              var data_url = data.url;
              var index_title = -1;
              var index_content = -1;
              var first_occur = -1;
              // only match artiles with not empty contents
              if (data_content !== '') {
                keywords.forEach(function (keyword, i) {
                  index_title = data_title.indexOf(keyword);
                  index_content = data_content.indexOf(keyword);

                  if (index_title < 0 && index_content < 0) {
                    isMatch = false;
                  } else {
                    if (index_content < 0) {
                      index_content = 0;
                    }
                    if (i == 0) {
                      first_occur = index_content;
                    }
                    // content_index.push({index_content:index_content, keyword_len:keyword_len});
                  }
                });
              } else {
                isMatch = false;
              }
              // 0x05. show search results
              if (isMatch) {
                str += "<li><a href='/" + data_url + "' class='search-result-title'><h2>" + orig_data_title + "</h2></a>";
                var content = orig_data_content;
                if (first_occur >= 0) {
                  // cut out 100 characters
                  var start = first_occur - 20;
                  var end = first_occur + 80;

                  if (start < 0) {
                    start = 0;
                  }

                  if (start == 0) {
                    end = 100;
                  }

                  if (end > content.length) {
                    end = content.length;
                  }

                  var match_content = content.substr(start, end);

                  // highlight all keywords
                  keywords.forEach(function (keyword) {
                    var regS = new RegExp(keyword, "gi");
                    match_content = match_content.replace(regS, "<span class=\"search-keyword\">" + keyword + "</span>");
                  });

                  str += "<h3 class=\"search-result-abstract\">" + match_content + "...</h3>"
                }
                str += "<hr></li>";
              }
            });
            str += "</ul>";
            if (str.indexOf('<li>') === -1) {
              return $resultContent.innerHTML = "<ul><span class='local-search-empty'>No result<span></ul>";
            }
            $resultContent.innerHTML = str;
          });
        },
        error: function(xhr, status, error) {
          $resultContent.innerHTML = ""
          if (xhr.status === 404) {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The search.xml file was not found, please refer toï¼š<a href='https://github.com/leedom92/hexo-theme-leedom#configuration' target='_black'>configuration</a><span></ul>";
          } else {
            $resultContent.innerHTML = "<ul><span class='local-search-empty'>The request failed, Try to refresh the page or try again later.<span></ul>";
          }
        }
      });
      $(document).on('click', '#search-close-icon', function() {
        $('#search-input').val('');
        $('#search-result').html('');
      });
    }

    var getSearchFile = function() {
        var path = "/search.xml";
        searchFunc(path, 'search-input', 'search-result');
    }
  </script>




    </div>
  </body>
</html>
